name: Build NekoLink

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2
    
    - name: Find csc.exe
      run: |
        $vspath = vswhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath
        $cscpath = Join-Path $vspath "MSBuild\Current\Bin\Roslyn"
        
        if (Test-Path $cscpath) {
          echo "CSC_PATH=$cscpath" >> $env:GITHUB_ENV
        } else {
          echo "CSC_PATH=C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\Roslyn" >> $env:GITHUB_ENV
        }
      shell: pwsh
    
    - name: Build Server
      run: |
        & "$env:CSC_PATH\csc.exe" Server.cs /out:NekoLink-Server.exe
      shell: pwsh
    
    - name: Build Client
      run: |
        & "$env:CSC_PATH\csc.exe" Client.cs /out:NekoLink-Client.exe /reference:Microsoft.VisualBasic.dll /reference:System.Windows.Forms.dll
      shell: pwsh
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: NekoLink
        path: |
          NekoLink-Server.exe
          NekoLink-Client.exe
